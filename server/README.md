# CollaboraText Server

## Setup

1. Install dependencies with `npm i`.

1. Copy `.env.dist` to `.env` and fill in the required values.

1. Copy `service-account-file.json.dist` to `service-account-key.json` and fill in the required values.

1. Run the server with `npm run start`.

## Handlers

Each handler is a listener to "message" events. Accepted data is a JSON tuple `[ACTION, PAYLOAD]`. With `ACTION` being a string with handler name and `PAYLOAD` being a JSON object with the data.

### `auth-user`

Authenticates user using Firebase tokens.

#### Payload

```javascript
{
    "token": "string"
}
```

#### Response

```javascript
{
    "userId": "string"
}
```

#### Throws

- `err-auth`: If wasn't able to authenticate user.

### `create-doc`

Creates a new document and returns the document id.

#### Payload

```javascript
{
}
```

#### Response

```javascript
{
    "id": "string"
}
```

#### Throws

- `err-auth-required`: If the user is not authenticated.
- `err-socket-doc-open`: If the socket already has a document open.

### `open-doc`

Opens a document and returns the document data.

#### Payload

```javascript
{
    "docId": "string"
}
```

#### Response

```javascript
{
    "id": "string",
    "name": "string",
    "creatorId": "string",
    "accessLevel": "AccessLevel", // "ONLY_OWNER", "READONLY", "ANYONE"
    "body": "string",
    "createdAt": "Date",
    "updatedAt": "Date",
    "isOwned": "boolean"
}
```

#### Throws

- `err-auth-required`: If the user is not authenticated.
- `err-no-doc`: If the document does not exist.

### `focus-doc`

Resets focus to document and returns up to date document data.

#### Payload

```javascript
{
}
```

#### Response

```javascript
{
    "id": "string",
    "name": "string",
    "creatorId": "string",
    "accessLevel": "AccessLevel", // "ONLY_OWNER", "READONLY", "ANYONE"
    "body": "string",
    "createdAt": "Date",
    "updatedAt": "Date",
    "isOwned": "boolean"
}
```

#### Throws

- `err-socket-doc-open`: If the socket has no document open.
- `err-no-doc`: If the document does not exist.

### `edit-doc`

Edits a document and returns updated document data to each connected socket.

#### Payload

```javascript
{
    "docId": "string",
    "patches": "any"
}
```

With paches being an object generated by the `DiffMatchPatch.patch_make` from `diff-match-patch` library.

#### Response

```javascript
{
    "id": "string",
    "patches": "any"
}
```

With paches being an recieved and applied object.

#### Throws

- `err-no-doc`: If the document does not exist.
- `err-patch-apply`: If the patch could not be applied or patch structure is invalid.

### `delete-doc`

Deletes a document.

#### Payload

```javascript
{
    "docId": "string",
}
```

#### Response

```javascript
{
}
```

#### Throws

- `err-auth-required`: If the user is not authenticated.
- `err-no-doc`: If the document does not exist.

#### Side Effect

- `close-doc`: If deleted document is open.

### `open-docs`

Returns brief information about all documents.

#### Payload

```javascript
{
}
```

#### Response

```javascript
[
	{
		id: "string",
		name: "string",
		creatorId: "string",
		briefBody: "string", // truncated body
		lastEditDate: "Date",
	},
];
```

### `update-doc-access`

Updates the access of a document and returns updated document data to each connected socket.

#### Payload

```javascript
{
    "docId": "string",
    "accessLevel": "AccessLevel", // "ONLY_OWNER",  "READONLY", "ANYONE"
}
```

#### Response

```javascript
{
   "id": "string",
   "accessLevel": "AccessLevel", // "ONLY_OWNER", "READONLY", "ANYONE"
}
```

#### Throws

- `err-auth-required`: If the user is not authenticated.
- `err-no-doc`: If the document does not exist.

#### Side Effect

- `close-doc`: If the user is no longer allowed to access document.

### `update-doc-name`

Updates the name of a document and returns updated document data to each connected socket.

#### Payload

```javascript
{
    "docId": "string",
    "name": "string"
}
```

#### Response

```javascript
{
   "id": "string",
   "name": "string"
}
```

#### Throws

- `err-no-doc`: If the document does not exist.

## Close handler `close-doc`

Closes the document. Listener to "close" event.

#### Throws

- `err-no-socket`: If the socket does not exist.
- `err-no-doc`: If the document does not exist.
- `err-socket-close`: If the socket does not close properly.
